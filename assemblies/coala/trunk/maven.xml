<?xml version="1.0" encoding="utf-8"?>

<!--                                         -->
<!-- ICW eHF Standard Configuration          -->
<!-- Created by the ICW eHF Project Template -->
<!--                                         -->
<project xmlns:ant="jelly:ant"
    xmlns:j="jelly:core"
    xmlns:maven="jelly:maven"
    xmlns:archive="release:archive"
    xmlns:util="jelly:util">

    <!-- ================================================================ -->
    <!--  Masterbuild goal                                                -->
    <!-- ================================================================ -->
    <goal name="masterbuild:all">
        <attainGoal name="ehf:release"/>
        <attainGoal name="saveZipBeforeClean"/>
        <attainGoal name="clean"/>
        <j:set var="maven.ehf.build.release" value="false"/>
        <j:set var="maven.ehf.db.skip.prepare" value="false"/>
        <j:set var="maven.test.skip" value="false"/>
        <attainGoal name="dev:build"/>
        <attainGoal name="restoreZipAfterClean"/>
        <attainGoal name="ehf:upload"/>
		<attainGoal name="ehf:generate-documentation"/>
		<attainGoal name="ehf:upload-documentation"/>
    </goal>
    
    <!-- ================================================================ -->
    <!--  General dev goal                                                -->
    <!-- ================================================================ -->
    <goal name="dev:build">
		<ant:exec outputproperty="svn.revision" executable="svnversion" dir="${basedir}">
			<ant:redirector>
				<ant:outputfilterchain>
					<ant:tokenfilter>
						<ant:replaceregex pattern="[M]+" replace="" />
					</ant:tokenfilter>
				</ant:outputfilterchain>
			</ant:redirector>
		</ant:exec>
		<ant:propertyfile file="${maven.build.dir}/classes/build.properties"
			comment="Build Information File - DO NOT CHANGE">
			<ant:entry key="build.svn.revision" type="int" value="${svn.revision}" />
			<ant:entry key="build.date" type="date" value="now" pattern="dd.MM.yyyy HH:mm" />
		</ant:propertyfile>
		<ant:echo>${svn.revision}</ant:echo>
		
        <attainGoal name="ehf:war"/>
		<attainGoal name="ehf:validate-webxml"/>
    </goal>
    
    <!-- Cleaning src/main/gen on project clean -->
    <postGoal name="clean:clean">
        <ant:delete includeEmptyDirs="true" failonerror="false">
            <fileset dir="${basedir}/src/main/gen" includes="**/*"/>
        </ant:delete>
        <ant:mkdir dir="${maven.build.dir}/classes" overwrite="true" />
        <ant:touch file="${maven.build.dir}/classes/build.properties" />
    </postGoal>
    
    <preGoal name="test:compile">
        <ant:delete includeEmptyDirs="true" failonerror="false">
            <fileset dir="${basedir}" includes="keypackage, keypackage/**/*"/>
        </ant:delete>
	</preGoal>
	
    <!-- this enables junit test being executed in eclipse with encryption 
    <preGoal name="test:test">
        <ant:copy file="keypackage/keystore.keys" todir="src/main/gen" overwrite="true"/> 
    </preGoal>
    -->
    
    <goal name="saveZipBeforeClean">
        <ant:echo>"maven.build.dest = ${maven.build.dest}"</ant:echo>
        <ant:mkdir dir="${basedir}/zipTmp" overwrite="true" />
        <ant:copy todir="${basedir}/zipTmp">
            <fileset dir="${maven.build.dir}"
                includes="*.zip" />
        </ant:copy>
        
    </goal>

    <goal name="restoreZipAfterClean">
        <ant:copy todir="${maven.build.dir}">
            <fileset dir="${basedir}/zipTmp"
                includes="*.zip" />
        </ant:copy>
        <delete failonerror="false">
            <fileset dir="${basedir}/zipTmp" includes="**/*"/>
        </delete>
    </goal>

</project>